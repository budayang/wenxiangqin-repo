事前防控
1、需求
需求阶段针对有资金风险的需求内容，必须要求PRD中阐述清楚，原则如下：
1） 需求语意明确，资金相关业务逻辑能够清晰记录和描述，各方评审落地，研发和业务放达成一致；
2）关键的资金要素内容，明确落地；
3）涉资的风险需求，必须要求有功能确认用例，产品上线重点关注。
2、系分
服务设计规约：
● 服务描述必须清晰（对于接口服务能力、数据交互描述不清楚，容易导致资损）
● 金额参数单位必须明确（金额单位的约定是极易出错的地方，分与元用哪个单位一定要明确，否则会导致金额扩大或缩小100倍）
● 幂等控制约束明确（幂等控制必须保证，幂等字段和内容，生成格式必须确认好达成共识，防止一笔业务单据重复执行产生问题）
● 服务参数长度必须明确（对外出入参数中，各参数的长度约定不明确，将引发数据库超长、数据截断、数据篡位等问题，严重时将导致资损）
● 错误码定义必须明确（错误码对于幂等、超时等结果不明确，会导致上游重复针对同一笔业务单据进行多次调用（调用时可能更换了幂等参数）或可以判定为成功的业务而认为是失败的）；
2.1、系分中明确系统交互流程中的资损风险点；
2.2、在接口设计时，明确指出哪些属性影响资金处理，并可能导致资损，明确指出哪些会影响幂等性控制等常见资损风险点；
2.3、考虑兼容性问题可能会导致的资损；
2.4、在设计上需要有资损安全的思考，也要考虑到核对监控的规则部署；
2.5、发布后的原有业务是否正常需要第一时间进行跟进确认；
3、研发编码规范
编码阶段通过一些代码规范，约定遇到具体的涉资场景，使用比较统一的代码处理方式，预防资损风险的发生，一些可参考的规则如下：
● 涉及到数值/金额的处理，使用统一的工具类 ，对于单位，币种，精度转换和运算处理，全局统一一套代码，控制全局风险，形成规范；
● 全局共享资源的使用，必须做好并发控制，防止资损（乐观锁，悲观锁，保障操作的原子性）；线程变量使用前后及时清理内容；
● 锁操作规范：
a、必须锁住以后再读取最新数据，经常有些错误是读取数据后再锁，锁住后没有重新读取数据，仍然基于脏数据做判断；
b、对同一数据的锁，要保证读取和更新时使用同一把锁；
c、在设计上要尽量减少锁的数量；
d、当设计上存在多把锁时，要考虑死锁的问题，所有的代码必须按同样的顺序去使用多把锁，这样可以避免死锁；
● 状态机设计的统一规范：统一控制状态机的迁移处理，避免不一致产生混乱；状态机判断必须穷举所有状态，防止遗漏；
● 资金处理类的代码处理，在代码执行前做好预处理检查，代码执行后做好关联数据的资金自平衡检查；
● 数据订正类代码规范：事前充分评估，订正脚本经过测试，订正操作规范执行，防止重复操作，操作影响数据复核确认。
4、架构设计约束
架构设计约束也是一种预防资金问题的有效手段，合理的架构设计能够使得研发设计和测试都能够很好的保证资金风险的敞口，使得整体的系统设计易于做资金风险控制和保障，可以参考的一些原则如下：
● 数据设计：核心数据设计必须保证上下游保存关联关系（主键，关联外键），数据必须可核对；
● 日志规范：核心的系统参数（涉及资金），必须打印摘要日志，便于排查定位，核对，分析应急；
● 业务幂等性控制设计符合当前业务需求和发展；
● 一致性约束规范：风格一致性、解决方案一致性、数据一致性；
● 完整性约束规范：数据完整性；
● 数据隔离设计：测试数据，仿真环境数据和真实数据隔离；线上灰度内部演练数据和真实客户数据做隔离，防止相互影响；（当前环境暂时无法支持）
● 兼容性设计：业务新老兼容，系统新老兼容，数据新老兼容，发布过程新老兼容，都需要考虑设计对应的代码开关手段控制风险，能够做到 老->新,新->老处理前后业务数据和代码逻辑状态的一致，同时设计对应的监控手段发现问题。
落地方案
1、需求相关落地方案：
在系分中，需要加上需求涉及资金安全的模块；
[X] 1、在系分中，需求涉及资金安全相关，必须要求产品资金安全相关逻辑在PRD描述清楚，且研发和业务认可，CR时重点关注资金安全相关；
[X] 2、资金安全相关逻辑必须要有功能测试用例，且场景覆盖率为100%；
2、系分相关落地方案：
[X] 1、HSF、Http的接口必须要有服务描述，对接口服务能力等进行阐述，排查当前应用的服务接口，进行补全，模版可参照https://yuque.antfin-inc.com/hmfinance/hkhmss/arzvhm idea代码格式化规范；
如果还未安装IDEA插件的需要进行安装；
[X] 2、系分中金额参数和币种需要明确写出，最好能标红凸显出来；
[X] 3、幂等控制约束在系分中需要罗列出来，只要有涉及到幂等操作，幂等键都需要写明；
[X] 4、服务参数长度在系分中也需要明确写出，需要进行超出长度自测；
[X] 5、针对每一种场景产生的错误码，在系分中要写出，并且错误场景也需要描述清楚；
格式：错误码：中文描述：错误产生原因
[X] 6、兼容性问题出现的资金风险点需要在系分中的“兼容性分析模块”列出；
[X] 7、系分中需要在“三板斧”中写出稽核监控方案、灰度方案，回滚方案、应急预案；
[X] 8、系分中需要写出单元测试方案；
系分文档模版：
https://yuque.antfin-inc.com/hmfinance/hkhmss/bweqvq
3、架构设计和研发编码落地方案：
[X] 1、架构设计时涉及资金安全接口必须打印出入参；
[X] 2、架构设计时业务幂等必须注明场景和幂等键；
[X] 3、一致性：
风格一致性：编码一致性，包括命名，格式目录结构等必须保持一致；
应用分层架构：
1、application 层：实现了业务的逻辑和流程的串接
2、interfaces 层：实现和外部的交互协议定义
3、service层：围绕领域对象聚合根的服务
4、infrastructure 层：DAL 实现数据资源的访问；RPC 现RPC资源的访问
5、daemon 层：daemon主要是异步处理层，实现消息和定时任务的的功能
6、repository 层：实现领域层的持久化
7、start 层：实现应用的spring-boot的autoconfig配置
解决方案一致性：遵循DDD的要求，为领域模型确定实体、值对象、聚合根、服务、工厂与资源库之间的明确划分，并明确地指出它们应该具备的特征；
[X] 4、兼容性设计：系分中必须体现业务新老兼容，系统新老兼容，数据新老兼容，发布过程新老兼容；
[X] 5、涉及到数值/金额的处理，在研发中都需要统一类进行处理；
[X] 6、核心的资金参数，必须打印日志，方便后续问题排查；
[X] 7、数据脚本订正，提交人必须重复检查，写明脚本更新影响范围，审批人必须认真审核，如有必要需要与提交人复核；
[X] 8、每次发布，只要代码行数超过10行 ，提交code review时，必须指明自己的单测类和单测覆盖；
4、发布相关方案：
[X] 1. 提测前就需要发起代码review，不要在发布前才做代码review。否则，有问题暴露太晚，改动风险太大。
[X] 2. 避免在月末最后一天做发布，每月前三个工作日是财务月结时间，按照AMC之前定的规则，影响财务月结也会算故障。再加上每月1号基本上全行业都是账期，如果发布出问题，留给我们处理问题时间太短，风险太大。
资金应急
资金应急主要是在发现资金风险问题后，主动控制问题影响范围，评估影响面（用户，资金，数据等），捞取问题数据进行恢复和处理等。
主要参与人员： 资金安全负责人、研发、业务等
1、资金应急步骤
[X] 问题发现上报技术侧
[X] 相关群信息同步，建立技术应急处理群，相关人员入群，定位问题
[X] 初步评估影响范围，制定止血方案和执行人员，负责人决策后执行止血
[X] 止血后捞取影响范围数据，评估影响面，决策恢复方案，同步业务侧（产品，公关，客满应对等），执行数据恢复处理
[X] 评估是否涉及资金应急处理（内部资金调账，外部资金追款等）
[X] 处理完毕总结复盘，上报GOC
2、资金应急规范
资金应急处理中的一些注意点和准则：
[X] 应急群研发，质量，SRE，产品四方尽量人员到齐，充分评估决策沟通，控制信息传播范围
[X] 止血执行必须小范围验证，有对应的验证和回滚手段
[X] 数据影响评估尽量双方复核（ 研发质量分析数据， SRE进行复核），影响范围和量级同步对应级别负责人决策
[X] 执行结果需要二次确认
遵守对应的资金应急准侧，能够防止资金问题处理过程中产生二次故障，扩大影响范围。
一、系统容灾、容错机制
1、灰度发布机制流程建设
1.1、在系统分析阶段需要给出当前业务的灰度方案
1.2、常见灰度方案有根据供应商、商家进行灰度
1.3、代码发布上线前必须有监控稽核
1.4、代码发布后必须第一时间进行灰度数据的验证，确保正确

发布check list：
[X] 1、灰度方案
[X] 2、上线后系统监控方案
[X] 3、上线后稽核方案
[X] 4、回滚方案
[X] 5、灰度数据处理方案

2、应用降级、限流策略

二、数据监控与报警治理
1、全链路稽核报警监控
2、应用报警监控

三、系统业务异常治理
1、接口超时治理
2、错误码治理
应用名-领域-错误描述
错误码标准制定：
1、错误码为字符串类型，分成三个部分：应用名-领域-错误描述；
2、错误码使用者避免随意定义新的错误码，尽量复用当前已有的错误码；
3、命名统一
中文	英文
参数	PARAMETER
非法的	ILLEGAL
不存在	NOT_EXIST
不能为空(包含NULL)	CANT_BE_EMPTY
空(包含NULL)	EMPTY
失败(包含ERROR异常)	FAILURE
例：
应用名	领域	错误描述	说明
SCHEDULER	TASK	NOT_EXIST	计费任务不存在

错误码标准制定：
1、错误码为字符串类型，共5位，分成两个部分：错误产生来源+四位数字编号：
说明：错误产生来源分为A/B/C，A表示错误来源于用户，比如参数错误，用户安装版本过低，用户支付超时等问题；B表示错误来源于当前系统，往往是业务逻辑出错，或程序健壮性差等问题；C表示错误来源于第三方服务，比如CDN服务出错，消息投递超时等问题；四位数字编号从0001到9999，大类之间的步长间距预留100；
2、错误码使用者避免随意定义新的错误码：
说明：尽可能在原有错误码附表中找到语义相同或者相近的错误码在代码中使用即可；
3、错误码之外的业务独特信息由error_message来承载，而不是让错误码本身涵盖过多具体业务属性；
错误码	中文描述	说明
00000	一切OK	正确执行后返回
A 表示来源于用户的错误码，比如参数错误等

B 表示错误来源于当前系统，比如业务逻辑出错等

C 表示错误来源于第三方服务，比如消息投递超时等



3、任务调度实时性治理
针对当前计费调度任务执行周期久的问题，导致计费实时性受到影响，可以针对这一块进行相应的治理；
4、慢SQL治理
经排查慢ascp_charge_task中慢sql主要是全表扫描引起的
1、扫表任务减少
2、历史数据迁移，减少数据量

5、状态机

6、日志打印治理
规范：
1、应用中不可直接使用日志系统（Log4j、Logback）中的API，而应依赖使用日志框架（SLF4J、JCL--Jakarta Commons Logging）中的API。
2、应用中的扩展日志（如打点、临时监控、访问日志等）命名方式：appName_logType_logName.log。logType:日志类型，推荐分类有stats/monitor/visit等；logName:日志描述。这种命名的好处：通过文件名就可知道日志文件属于什么应用，什么类型，什么目的，也有利于归类查找。
3、在日志输出时，字符串变量之间的拼接使用占位符的方式。
说明：因为String字符串的拼接会使用StringBuilder的append()方式，有一定的性能损耗。使用占位符仅是替换动作，可以有效提升性能。
4、对于trace/debug/info级别的日志输出，必须进行日志级别的开关判断。
说明：虽然在debug(参数)的方法体内第一行代码isDisabled(Level.DEBUG_INT)为真时（Slf4j的常见实现Log4j和Logback），就直接return，但是参数可能会进行字符串拼接运算。此外，如果debug(getName())这种参数内有getName()方法调用，无谓浪费方法调用的开销。
5、生产环境禁止直接使用System.out 或System.err 输出日志或使用e.printStackTrace()打印异常堆栈。
说明：标准日志输出与标准错误输出文件每次Jboss重启时才滚动，如果大量输出送往这两个文件，容易造成文件大小超过操作系统大小限制。
6、异常信息应该包括两类信息：案发现场信息和异常堆栈信息。如果不处理，那么往上抛。
logger.error("inputParams:{} and errorMessage:{}", 各类参数或者对象toString(), e.getMessage(), e);
7、日志打印时禁止直接用JSON工具将对象转换成String。
说明：如果对象里某些get方法中直接抛出异常，则JSON工具调用其get方法时被迫中断而影响正常业务流程的执行。
打印日志时仅打印出业务相关属性值或者调用其对象的toString()方法。
8、尽量用英文来描述日志错误信息，如果日志中的错误信息用英文描述不清楚的话使用中文描述即可，否则容易产生歧义。
9、在历史代码中的增加或改动，尤其是增加一段异步执行的代码，在代码执行前后加info级别的日志+参数（若有）进行监测，务必确认这些代码被有效执行完成，稳定后再去掉。
说明：有些异步代码并不block主线程，这个异步代码的执行，可能会因为异常、或有问题的条件判断，被忽略。如果日志量非常高频，则使用Random类抽样打印。
7、事物一致性治理
治理前：调度系统ascp-charge-scheduler存在主单生成，子单未生成的数据；
治理后：调度系统ascp-charge-scheduler未出现事物不一致的数据；
排查其它应用
四、监控大盘建设
目的：代码发布后可以根据监控大盘进行监控，保证问题解决的及时性；